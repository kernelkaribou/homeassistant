server {
    listen 80 default_server;

    include /etc/nginx/includes/server_params.conf;
    include /etc/nginx/includes/proxy_params.conf;

    # location / {
    #     return 302 $scheme://$http_host%%ingress_entry%%/;
    # }
    # Fallback for root requests
    location / {
        return 404;
    }
    
    location %%ingress_entry%% {
        allow   127.0.0.1;
        allow   172.30.32.2;
        deny    all;
        
        # Handle both with and without trailing slash
        rewrite ^%%ingress_entry%%$ %%ingress_entry%%/ permanent;
        rewrite ^%%ingress_entry%%/(.*)$ /$1 break;

        proxy_pass http://dozzle/;
        proxy_redirect off;
        
        # Additional headers for proper ingress handling
        proxy_set_header X-Ingress-Path "%%ingress_entry%%";
    }
}